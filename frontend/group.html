<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Groupe</title>
    <link rel="stylesheet" href="static/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-dark text-white">
<nav class="navbar navbar-expand-lg navbar-glass px-3">
    <a id="backBtn" class="navbar-brand text-white fw-bold" style="cursor:pointer">← Retour</a>
    <div class="ms-auto">
        <button class="btn btn-glass" onclick="logout()">Déconnexion</button>
    </div>
</nav>
<script>document.getElementById("backBtn").onclick = () => history.back();</script>

<div class="container mt-4">
    <h1 id="groupName" class="page-title mb-3"></h1>

    <div class="row">
        <div class="col-md-6">
            <div class="card-glass p-3 mb-3">
                <h5>Membres</h5>
                <div class="d-flex mb-2">
                    <button id="btnInvite" class="btn btn-main btn-sm me-2">Générer invitation</button>
                    <input id="inviteOutput" class="form-control form-control-sm" readonly placeholder="Lien d'invitation apparaitra ici">
                </div>
                <ul id="memberList" class="list-group mt-2"></ul>
            </div>

            <div class="card-glass p-3">
                <h5>Créer une tâche</h5>
                <div class="mb-2">
                    <input id="taskTitle" class="form-control mb-2" placeholder="Titre">
                    <textarea id="taskDesc" class="form-control mb-2" placeholder="Description"></textarea>
                    <div class="d-flex gap-2 mb-2">
                        <select id="taskStatus" class="form-select">
                            <option value="todo">To do</option>
                            <option value="doing">Doing</option>
                            <option value="done">Done</option>
                        </select>
                        <input id="taskDeadline" type="date" class="form-control">
                    </div>
                    <button class="btn btn-main" onclick="addTask()">Ajouter</button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card-glass p-3">
                <h5>Tâches</h5>
                <ul id="taskList" class="list-group mt-2"></ul>
            </div>
        </div>
    </div>
</div>

<!-- Edit modal (simple) -->
<div class="modal" tabindex="-1" id="editModal">
  <div class="modal-dialog">
    <div class="modal-content bg-secondary text-white">
      <div class="modal-header">
        <h5 class="modal-title">Modifier la tâche</h5>
        <button type="button" class="btn-close" aria-label="Close" id="closeModal"></button>
      </div>
      <div class="modal-body">
        <input id="editTitle" class="form-control mb-2" placeholder="Titre">
        <textarea id="editDesc" class="form-control mb-2" placeholder="Description"></textarea>
        <div class="d-flex gap-2 mb-2">
            <select id="editStatus" class="form-select">
                <option value="todo">To do</option>
                <option value="doing">Doing</option>
                <option value="done">Done</option>
            </select>
            <input id="editDeadline" type="date" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button id="saveEdit" class="btn btn-main">Enregistrer</button>
        <button id="cancelEdit" class="btn btn-glass">Annuler</button>
      </div>
    </div>
  </div>
</div>

<script src="static/app.js"></script>
<script>
const urlparams = new URLSearchParams(window.location.search);
const groupId = urlparams.get("id");
if (!groupId) {
    alert("Aucun groupe sélectionné !");
    window.location.href = "groups.html";
}

let editingTaskId = null;

async function loadGroup() {
    const group = await fetchGroup(groupId);
    groupName.textContent = group?.name || ("Groupe #" + groupId);

    // members
    const members = await fetchGroupMembers(groupId);
    memberList.innerHTML = "";
    (members || []).forEach(m => {
        memberList.innerHTML += `
            <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                <div><strong>${m.username}</strong> <small class="text-muted">(${m.email})</small></div>
                <div>
                    ${m.role === "admin" ? '<span class="badge bg-info me-2">admin</span>' : ''}
                    <button class="btn btn-sm btn-outline-light" onclick="removeMemberConfirm(${m.user_id})">Retirer</button>
                </div>
            </li>
        `;
    });

    // tasks
    const tasks = await fetchGroupTasks(groupId);
    taskList.innerHTML = "";
    (tasks || []).forEach(t => {
        taskList.innerHTML += `
            <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                <div>
                  <strong>${t.title}</strong><br>
                  <small>${t.description || ""}</small><br>
                  <small class="text-muted">${t.status} ${t.deadline ? ' • ' + t.deadline : ''}</small>
                </div>
                <div>
                  <button class="btn btn-sm btn-outline-light me-1" onclick="openEdit(${t.id}, '${escapeHtml(t.title)}', '${escapeHtml(t.description || '')}', '${t.status}', '${t.deadline || ''}')">Modifier</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteAndReload(${t.id})">Suppr</button>
                </div>
            </li>
        `;
    });
}

function escapeHtml(s) {
    return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"');
}

// invite
btnInvite.onclick = async () => {
    const res = await generateInvite(groupId);
    if (res && res.invite_link) {
        inviteOutput.value = res.invite_link;
        inviteOutput.select();
    } else {
        alert("Impossible de générer le lien");
    }
};

// remove member confirm
function removeMemberConfirm(userId) {
    if (!confirm("Confirmer le retrait de ce membre ?")) return;
    removeMember(groupId, userId).then(r => {
        alert(r?.message || "Retiré");
        loadGroup();
    });
}

// tasks
async function addTask() {
    const title = taskTitle.value.trim();
    if (!title) { alert("Entrez un titre"); return; }
    const description = taskDesc.value.trim();
    const status = taskStatus.value;
    const deadline = taskDeadline.value || null;
    await createTask(groupId, title, description, deadline, status);
    taskTitle.value = ""; taskDesc.value = ""; taskDeadline.value = "";
    loadGroup();
}

async function deleteAndReload(id) {
    if (!confirm("Supprimer cette tâche ?")) return;
    await deleteTask(id);
    loadGroup();
}

// edit modal functions
function openEdit(id, title, desc, status, deadline) {
    editingTaskId = id;
    editTitle.value = title.replace(/\\'/g,"'").replace(/\\"/g,'"');
    editDesc.value = desc.replace(/\\'/g,"'").replace(/\\"/g,'"');
    editStatus.value = status || 'todo';
    editDeadline.value = deadline ? deadline.split('T')[0] : '';
    document.getElementById('editModal').style.display = 'block';
}

document.getElementById('closeModal').onclick = () => document.getElementById('editModal').style.display = 'none';
document.getElementById('cancelEdit').onclick = () => document.getElementById('editModal').style.display = 'none';

document.getElementById('saveEdit').onclick = async () => {
    if (!editingTaskId) return;
    const data = {
        title: editTitle.value.trim(),
        description: editDesc.value.trim(),
        status: editStatus.value,
        deadline: editDeadline.value || null
    };
    await updateTask(editingTaskId, data);
    document.getElementById('editModal').style.display = 'none';
    loadGroup();
};

loadGroup();
</script>
</body>
</html>
